<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="generator" content=
  "HTML Tidy for Linux/x86 (vers 25 March 2009), see www.w3.org">

  <title>Interactive Steam Trading Card Sheet</title>
  <meta name="viewport" content=
  "width=device-width, initial-scale=1.0">
  <link href="css/bootstrap.css" rel="stylesheet" media=
  "screen" type="text/css">
  <script src=
  "//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js"
  type="text/javascript">
</script>
  <script src="js/bootstrap.js"></script>
  <script src="js/spin.min.js"
  type="text/javascript">
  </script>
<script src="js/__jquery.tablesorter.min.js" type="text/javascript"></script>
<script type="text/javascript" language="javascript">
//some awesome prototypes
//super awesome numerical hash, no really a lifesaver!
String.prototype.hashCode = function(){
    var hash = 0, i, char;
    if (this.length == 0) return hash;
    for (i = 0, l = this.length; i < l; i++) {
        char  = this.charCodeAt(i);
        hash  = ((hash<<5)-hash)+char;
        hash |= 0; // Convert to 32bit integer
    }
    return hash;
};
//repeatables
String.prototype.repeat = function( num )
{
    var cat = '';
    var dog = this;
    for (var i = 0; i < num; i++){
        cat = cat + dog;
    }
    return cat;
}

function loader() {
    $('#error').empty();
    $('#playerName').html('<h1>Viewing All Games</h1>');
    var opts = {
        lines: 13,
        // The number of lines to draw
        length: 20,
        // The length of each line
        width: 10,
        // The line thickness
        radius: 30,
        // The radius of the inner circle
        corners: 1,
        // Corner roundness (0..1)
        rotate: 0,
        // The rotation offset
        direction: 1,
        // 1: clockwise, -1: counterclockwise
        color: '#000',
        // #rgb or #rrggbb or array of colors
        speed: 1,
        // Rounds per second
        trail: 60,
        // Afterglow percentage
        shadow: false,
        // Whether to render a shadow
        hwaccel: false,
        // Whether to use hardware acceleration
        className: 'spinner',
        // The CSS class to assign to the spinner
        zIndex: 2e9,
        // The z-index (defaults to 2000000000)
        top: '30',
        // Top position relative to parent in px
        left: 'auto' // Left position relative to parent in px
    }
    var target = document.getElementById('stage');
    var spinner = new Spinner(opts).spin(target);
    webstuff(spinner, function(spinner){spinner.stop();});
}
//globalstore
var store = {};
function webstuff(spinner, callback) {
    $.getJSON('http://api.chpwner.org:82/data/Games/', function (games) {
        var length = games.length;
        var c = 0;
        var ctotal = 0;
        for (var i = 0; i < length; i++) {
            var jd = games[i];
            jd.idhash = 'g' + jd.name.hashCode();
            store[jd.idhash] = jd;
			jd.sum = 0;
			jd.fsum = 0;
			jd.count = 0;
			jd.fcount = 0;
			jd.time = 0;
            for (var j in jd.cards) {
                var jsonstring = jd.cards[j];
                //console.log(jsonstring);
                var parse = JSON.parse(jsonstring);
                var time = "";
                if (parse.trading_card == true && parse.itemtype.indexOf("Foil") == -1) {
                    //override cards with price to get array of prices of cards
                    //jd.cards[j] = parse.price;
                    jd.time = parse.updated;
					jd.sum = jd.sum + parse.price;
					jd.count++;
                }
                else if (parse.trading_card == true && parse.itemtype.indexOf("Foil") != -1) {
                    //override cards with price to get array of prices of cards
                    //jd.cards[j] = "foil "+ parse.price;
                    jd.time = parse.updated;
					jd.fsum = jd.fsum + parse.price;
					jd.fcount++;
                }
                else {
                    //override cards with price to get array of prices of cards
                    //jd.cards[j] = "not a card";
                    //jd.time = parse.updated;
                }
            }
            jd.avg = (jd.sum/jd.count).toFixed(2);
            jd.favg = (jd.fsum/jd.fcount).toFixed(2);
            jd.ccs = (jd.count * jd.avg).toFixed(2);
            jd.ccfs = (jd.fcount * jd.favg).toFixed(2);
			if (jd.count > 0) {
				if (jd.count != jd.fcount){flag = ' error';}else{flag='';}
	            $('#stage').append('<tr id="'+ jd.idhash + '" class="cardrow'+ flag +'"><!--<td>' + jd.appid + '</td>--><td>' + jd.name + '</td><td>' + jd.count+ '/' + jd.fcount + '</td><td class="cardsowned">0</td><td class="fcardsowned">0</td><td class="percentage">0%</td><td class="lvl">0</td><td class="flvl">0</td><td>' + jd.avg + '</td><td>' + jd.favg + '</td><td class="ccs">' + jd.ccs + '</td><td class="ccfs">' + jd.ccfs + '</td><td>' + jd.time + '</td><td><button type="button" class="btn btn-small upbtn" name="update" value="'+ jd.name + '" id="'+ jd.idhash + '" data-loading-text="Loading...">update</button></td><\/tr>');
                c++;
                ctotal = ctotal + jd.count + jd.fcount;
			}
            else{
	            $('#stage').append('<tr id="'+ jd.idhash + '" class="noncardrow"><!--<td>' + jd.appid + '</td>--><td>' + jd.name + '</td><td>0</td><td class="cardsowned">0</td><td class="fcardsowned">0</td><td class="percentage">0%</td><td class="badgelevel">0</td><td>0</td><td>0</td><td>0</td><td class="ccs">0</td><td class="ccfs">0</td><td>0</td><td><button type="button" class="btn btn-small upbtn" name="update" value="'+ jd.name + '" id="'+ jd.idhash + '" data-loading-text="Loading...">update</button></td><\/tr>');
            }
        }
		//table sorter
		$("#datatable").tablesorter(); 
		//spinner stopper callback
        callback(spinner);
        //some jquery setup
        $('#searchBtn').attr('disabled', false);
        $('#gamecount').text('Game Count: '+ length);
        $('#itemcount').text('Card Count: ' + ctotal);
        $('#badgecount').text('Badge Count: ' + c*2);
        //load buttons
        buttons();
    }).fail(function (jqxhr, textStatus, error) {
        spinner.stop();
        var err = textStatus + ', ' + error;
        $('#error').append('Request Failed ' + err);
    })
}

function validateID(InString)  {
    if(InString.length != 17) return (false);
    var RefString="1234567890";
    for (Count=0; Count < InString.length; Count++)  {
        TempChar= InString.substring (Count, Count+1);
        if (RefString.indexOf (TempChar, 0)==-1)  
            return (false);
    }
    return (true);
}
//globals?
var tr;
var p;
var pstore;
function getUser(form){
    //disable some buttons
    $('#sub').remove();
    $('#updProfile').attr('disabled',true);
    
    //reset hide if applicable
    if (p){$('#toggle').trigger('click');}

    //reset flags
    $('#stage').children('tr.flag').removeClass('flag');
    //reset filtered games if applicable
    $('#stage').append(tr);
    
    var steamid = form.steamid.value;
    form.steamid.value = "Loading...";
    form.searchBtn.disabled = true;
    
    if(validateID(steamid)){
        data = {'steamid':steamid};
    }
    else if (steamid != ''){
        data = {'personaname':steamid};
    }
    else{
        form.searchBtn.disabled = false;
        form.steamid.value = "No ID entered!";
        return('no id entered');
    }
    $.getJSON('http://api.chpwner.org:82/data/Players/', data, function (profile) {
        var profile = profile[0];
        if (!(profile))
        {
            form.searchBtn.disabled = false;
            form.steamid.value = "Not Found!";
            $('#userform').attr('action','adduser.php');
            $('#userform').attr('method','post');
            $('#userform').append('<input id="sub" class="btn btn-success" type="submit" value="Add New ID">');
            return('user not in database');
        }
        pstore = profile;
        form.searchBtn.disabled = false;
        form.steamid.value = "Finnished!";
        $('#playerImage').attr('src', profile.avatar);
        $('#playerName').html("<h1>Viewing " + profile.personaname + "'s Games</h1>");
        $('#gamecount').text('Game Count: ' + profile.licenses.length);
        $('#itemcount').text('Item Count: ' + profile.items.length);
        $('#badgecount').text('Badge Count: ' + profile.badges.length);
        var lvlArr = [0,0,0,0,0,0];
        var foil = 0;
        for (var i in profile.badges){
            var badge = profile.badges[i];
            var pos = badge.indexOf('vl:');
            var lvl = badge.substring(pos+3,pos+4);
            if (badge.indexOf('Foil') == -1){
                lvlArr[lvl]++;
            }
            else{
                foil++;
            }
        }
       $('#lvl1').text(lvlArr[1]);
       $('#lvl2').text(lvlArr[2]);
       $('#lvl3').text(lvlArr[3]);
       $('#lvl4').text(lvlArr[4]);
       $('#lvl5').text(lvlArr[5]);
       $('#lvlFoil').text(foil);
       
       //modify table
       var len = profile.personaname.length + 3;
       for (var j in profile.licenses){
           var game = 'g' + profile.licenses[j].substring(len).hashCode();
           $('#'+game).addClass('flag');
           updateTable(game);
       }
       //remove nonflagged
       tr = $('#stage').children('tr:not(tr.flag)').detach();
       //update tablesorter
       $("#datatable").trigger("update");
       
       //reenable buttons
       $('#updProfile').attr('disabled',false);
    })
return (true);
}

function updateTable(id){
    //reset notifiers
    $('#'+id).removeClass('success');
    $('#'+id).removeClass('info');
    $('#'+id).removeClass('warning');
    $('#'+id).children('td.percentage').attr('style', '')

    var jd = store[id];
    var gamename = jd.name;
    var cards = {};
    var badgeObj = {};
    
    //check if profile data loaded and we have a game with cards
    if(pstore && jd.count > 0){
    //manipulate items to get assoc array of hashcodes
    //for the most part json str are goning to be the same
    //unless an update was triggered after getting composite data
    //but before getting the profile
    var items = pstore.items;
    for (var i in items){
        var jsonstring = items[i];
        var parse = JSON.parse(jsonstring);
        //skip nontrading cards
        if(!(parse.trading_card)){continue;}
        var idhash = 'hc' + parse.itemname.hashCode();
        if (cards[idhash]){
            cards[idhash]['quanity']++;
        }else{
            cards[idhash] = {'itemname':parse.itemname, 'quanity':1};
        }
    }
    
    var owned = 0;
    var fowned = 0;
    for (var k in jd.cards) {
        var jsonstring = jd.cards[k];
        var parse = JSON.parse(jsonstring);
        //skip nontrading cards
        if(!(parse.trading_card)){continue;}
        var hash = 'hc' + parse.itemname.hashCode();
        var str = parse.itemname + ' costs ' + parse.price + ' as of ' + parse.updated + "<br/>";
        $('#cardlist').append('<td>'+str+'</td>');
        if(cards[hash] && parse.itemtype.indexOf('Foil') == -1){
            owned++;
        }
        else if (cards[hash] && parse.itemtype.indexOf('Foil') != -1){
            fowned++;
        }
    }
    $('#'+id).children('td.cardsowned').text(owned);
    $('#'+id).children('td.fcardsowned').text(fowned);
    
    var fraction = owned + '/' + jd.count;
    var percent = ((owned / jd.count)*100).toFixed(0);
    var ps = percent + '% = ' + fraction
    $('#'+id).children('td.percentage').text(ps)
    if (percent >= 50){
        $('#'+id).children('td.percentage').attr('style', 'color:green')
    }
    
    var ccs = ((jd.count - owned)*jd.avg).toFixed(2);
    $('#'+id).children('td.ccs').text(ccs);
    
    var ccfs = ((jd.fcount - fowned)*jd.favg).toFixed(2);
    $('#'+id).children('td.ccfs').text(ccfs);
    
    var badges = pstore.badges;
    for (var j in badges){
        var badge = badges[j];
        var pos = badge.indexOf(' (Lvl:');
        var badgename = badge.substring(0,pos);
        var sets = badge.substring(pos+6, pos+7)
        var idhash = 'g' + badgename.hashCode();
        badgeObj[idhash] = sets;
    }
    if (badgeObj[id]){
        str = badgeObj[id] + " :) ".repeat(badgeObj[id]);
        if (badgeObj[id] == 5){
            str = "5 :D"
            $('#'+id).addClass('success');
            $('#'+id).children('td.percentage').text('100%')
            $('#'+id).children('td.ccs').text('Maxed!');
        }
        else if (badgeObj[id] == 4){
            //$('#'+id).addClass('info');
        }
    }else{
        str = "0";
    }
    $('#'+id).children('td.lvl').text(str);
    
    var fid = 'g' + (gamename + ' (Foil)').hashCode();
    if (badgeObj[fid]){
        str = "1 XD";
        $('#'+id).children('td.ccfs').text('Maxed!');
        $('#'+id).addClass('success');
        if (badgeObj[id] == 5){
            $('#'+id).removeClass('success');
            $('#'+id).addClass('warning');
            $('#'+id).children('td.percentage').text('200%')
            $('#'+id).children('td.lvl').text('6 ;)');
        }
    }else{
        str = "0";
    }
    $('#'+id).children('td.flvl').text(str);
    }
}

function buttons(){
    //game info trigger
    $('#stage').children().click(function(){gameLookup(this);});

    //profile update
    $('#updProfile')
      .click(function () {
        var btn = $(this);
        btn.button('loading');
        updateProfile(btn, function(btn){btn.button('reset');});
      })
      
    //price update button
    $('.upbtn')
      .click(function () {
        var btn = $(this);
        btn.button('loading');
        updatePrice(btn, function(btn){btn.button('reset');});
      })

    //hide button
    //var p; is global now
    $("#toggle").click(function() {
    if (p) {
        console.log("unclicked");
        p.appendTo("#stage");
        p = null;
        $("#datatable").trigger("update");
        $("#toggle").text('Hide Noncard Games');
    } else {
        console.log("clicked");
        p = $("tr.noncardrow").detach();
        $("#datatable").trigger("update");
        $("#toggle").text('Show Noncard Games');
    }
    });
}
//disable enter key so user has to click buttons
$(document).keypress(
    function(event){
     if (event.which == '13') {
        event.preventDefault();
      }
});

function gameLookup(btn){
    console.log("game detail not implemented yet");
}

function updatePrice(btn, callback){
    var jqBtn = $(btn);
    var game = jqBtn.attr('value');
    var id = jqBtn.attr('id');
    console.log("hashcode "+id+" value "+game);
    
    $.getJSON( "http://192.168.1.3:8000/update/price/", {'game':game},function(data) {
        console.log(data);
    })
    .fail(function( jqxhr, textStatus, error ) {
        var err = textStatus + ", " + error;
        console.log( "Request Failed: " + err );
    })
    .always(function() {
        callback(btn);
    });
}

function updateProfile(btn, callback){
    updateGames(btn, callback);
    updateBadges(btn, callback);
    updateInventory(btn, callback);
    callback(btn);
}

function updateGames(btn, callback){
    console.log("updInv not implemented yet");
    callback(btn);
}

function updateBadges(btn, callback){
    console.log("updBdg not implemented yet");
    callback(btn);
}

function updateInventory(btn, callback){
    console.log("updInv not implemented yet");
    callback(btn);
}
</script>
</head>
<body>
<div class="container-fluid">
<div class="row-fluid">
<div class="span2">
<!--logo-->
</div>
<div class="span10">
<!--nav-->
</div>
</div>
<div class="row-fluid">
<div class="span2" id="sidebar">
<img id="playerImage" src="http://www.gravatar.com/avatar/9cc01cfb905ec56d582629e259f20589?s=184" class="img-rounded">
<form id="userform">
  Steam name or id:</br>
  <input type="text" name="steamid" class="span12"><br/>
  <button type="button" class="btn" name="searchBtn" id="searchBtn" onClick="getUser(this.form)" disabled=true>Load Profile</button>
</form>
<br/>
<p id="gamecount"></p>
<p id="itemcount"></p>
<p id="badgecount"></p>
<p>
Lvl 5: <span id="lvl5"></span><br/>
Lvl 4: <span id="lvl4"></span><br/>
Lvl 3: <span id="lvl3"></span><br/>
Lvl 2: <span id="lvl2"></span><br/>
Lvl 1: <span id="lvl1"></span><br/>
</p>
<p>
Foil: <span id="lvlFoil"></span>
</p>
<p><button type="button" class="btn" id="updProfile" data-loading-text="Loading..." disabled=true>Update Profile</button></p>
</div>
<div class="span10">
<div>
<div style="float:left" id="playerName">
<h1>Interactive Steam Trading Card Sheet</h1>
<h2>By Chpwner</h2>
</div>
<div style="float:right"><button type="button" id="toggle" class="btn btn-info">Hide Noncard Games</button></div>
</div>
<div>
  <table class="table table-bordered table-hover tablesorter" id="datatable">
	<thead>
    <tr>
      <!--<th>Appid</th>-->
      <th>Name</th>
	  <th>Cards Per Set</th>
      <th>Cards Owned</th>
      <th>Foil Cards Owned</th>
      <th>Percent Complete</th>
      <th>Complete Sets</th>
      <th>Complete Foil Sets</th>
      <th>Avg Card Cost</th>
      <th>Avg Foil Card Cost</th>
      <th>Cost to Complete Set</th>
      <th>Cost to Complete Foil Set</th>
      <th>Prices Last Updated</th>
	  <th></th>
    </tr>
	</thead>
	<tbody id="stage">
	</tbody>
  </table>
<div id="error">
<h3>Instructions</h3>
<p>This site accesses <strong>public profile</strong> information from Steam to help with<br/>
trading card collection, including community market price integration. </p>
<p>After table is loaded: 
<ul>
<li>Load a profile using form on the left</li>
<li>Click on the headers to sort table</li>
<li>"Shift click" to sort by more than one category</li>
<li>Hide superfluous games by clicking the button at the top right</li>
</ul>
</p>
<p>Color code legend: 
<ul>
<li><span style="background-color:#d0e9c6">Green: Lvl 5 Badge or Lvl 1 Foil Badge</span></li>
<li><span style="background-color:#fcf8e3">Gold: Lvl 5 Badge and Lvl 1 Foil Badge</span></li>
<li><span style="background-color:#d9edf7">Blue: Market update in progress...</span></li>
<li><span style="background-color:#f2dede">Red: Missing trading cards,
the rarest cards<br/> are so rare no one has them for sale in the market</span></li>
<li><span style="Color:green">Green Text: >= 50% progress toward a badge</span></li>
</ul>
</p>
<p>
This site uses a local cache of Steam's information, so it is not always up to date. <br/>
Various update buttons are located on the page to gather new information. </p>
<p>Start by loading all games into the table:</p>
<p>
<button class="btn btn-primary" onClick="loader()">Load Page</button>
</p>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
